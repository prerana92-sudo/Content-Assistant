<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot with Speech-to-Text</title>
  </head>
  <body>
    <h1>Chatbot with Speech-to-Text</h1>
    <button id="start-recognition">Start Speech Recognition</button>
    <script type="module">
      import Chatbot from "https://cdn.jsdelivr.net/gh/Digiinteracts/FlowiseChatEmbed/dist/web.js";
      Chatbot.init({
        chatflowid: "9355f610-e5a2-4825-8130-cc991027076e",
        apiHost: "https://mmade-flowisemasterymade.hf.space",
      });

      // Function to capture audio and send it to the API
      async function captureAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const mediaRecorder = new MediaRecorder(stream);
        const audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const reader = new FileReader();
          reader.readAsDataURL(audioBlob);

          reader.onloadend = () => {
            const base64data = reader.result.split(",")[1];
            query({
              uploads: [
                {
                  data: `data:audio/webm;codecs=opus;base64,${base64data}`,
                  type: "audio",
                  name: "audio.wav",
                  mime: "audio/webm",
                },
              ],
            }).then((response) => {
              console.log(response);
            });
          };
        };

        mediaRecorder.start();
        setTimeout(() => {
          mediaRecorder.stop();
        }, 5000); // Record for 5 seconds
      }

      // Function to query the API
      async function query(data) {
        const response = await fetch(
          "https://mmade-flowisemasterymade.hf.space/api/v1/prediction/9355f610-e5a2-4825-8130-cc991027076e",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          }
        );
        const result = await response.json();
        return result;
      }

      document
        .getElementById("start-recognition")
        .addEventListener("click", captureAudio);
    </script>
  </body>
</html>
